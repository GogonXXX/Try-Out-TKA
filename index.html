<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ASAS SD NEGERI YANTI ‚Äî ExamBrowser Web</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0e639c">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Arial, sans-serif; }
    body { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: #333; line-height: 1.6; padding: 20px; min-height: 100vh; }
    .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.2); overflow: hidden; }
    header { background: linear-gradient(135deg, #2d2d30 0%, #4a4a4f 100%); padding: 20px; border-bottom: 3px solid #0e639c; text-align: center; color: white; }
    h1 { color: #fff; font-size: 28px; margin-bottom: 4px; }
    .subtitle { color: #cccccc; font-size: 14px; font-weight: 300; }
    .content { padding: 22px; }
    .menu { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 10px; padding: 18px; background: #f8f9fa; border-radius: 8px; border: 2px solid #e9ecef; align-items: center; }
    input[type="text"], input[type="number"], textarea { padding: 8px; border-radius: 6px; border: 2px solid #ced4da; background: white; color: #495057; font-size: 14px; transition: border-color .3s; width: 100%; }
    button { background: #0e639c; color: #fff; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: all .18s; font-weight: 700; }
    .card { background: white; border-radius: 10px; padding: 18px; box-shadow: 0 4px 15px rgba(0,0,0,.08); margin-bottom: 15px; border: 2px solid #e9ecef; }
    .time { font-weight: bold; color: #e11d48; margin-bottom: 10px; font-size: 18px; text-align: center; padding: 8px; border-radius: 8px; background: #fff5f5; border: 2px solid #e11d48; }
    .panel-buttons { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
    .panel-buttons button { width: 44px; height: 44px; border-radius: 8px; border: 2px solid #e6e6e6; background: white; color: #111; font-weight: 700; cursor: pointer; }
    .panel-buttons button.answered { background: #ecfdf5; border-color: #bbf7d0; color: #166534; }
    .panel-buttons button.marked { background: #fffbeb; border-color: #fde68a; color: #92400e; }
    .panel-buttons button.current { background: #eff6ff; border-color: #bfdbfe; color: #0f4aa1; }
    .score-display { font-size: 22px; font-weight: 700; text-align: center; padding: 12px; margin: 12px 0; border-radius: 8px; background: linear-gradient(135deg, #22c55e, #16a34a); color: #fff; }
    .no-select { user-select: none; -webkit-user-select: none; -ms-user-select: none; }
    .answer-btn {
  display: block;
  width: 100%;
  margin: 8px 0;
  padding: 12px;
  text-align: left;
  background: #ffffff;
  color: #000000;  /* TEKS WARNA HITAM */
  border: 2px solid #cbd5e1;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
}

.answer-btn:hover {
  background: #f1f5f9;
  color: #000000;  /* JAGA WARNA HITAM SAAT HOVER */
}

.answer-btn.active {
  background: #e0f2fe;
  color: #000000;  /* TEKS TETAP HITAM SAAT AKTIF */
  border-color: #38bdf8;
  font-weight: 700;
}
  </style>
</head>
<body class="no-select">
  <div class="container" id="app">
    <header>
      <h1>ASESMENT SUMATIF AKHIR SEMESTER</h1>
      <h1>SEKOLAH DASAR NEGERI YANTI</h1>
      <p class="subtitle">Tahun Ajaran 2025/2026 ‚Äî Mode Ujian Terkunci</p>
    </header>
    
    <div class="content">
      <div class="menu">
        <label style="width:220px">Nama Siswa:
          <input id="namaSiswa" type="text" placeholder="Masukkan nama lengkap" style="width:220px;margin-left:8px">
        </label>
        <label>Waktu (menit):
          <input id="setTime" type="number" value="30" min="1" max="180" style="width:80px;margin-left:8px">
        </label>
        <button onclick="startTest()" id="startBtn">üöÄ Mulai Tes</button>
        <button onclick="finishTest()" id="finishBtn">‚úÖ Selesai</button>
        <button onclick="exportJawaban()">üì§ Ekspor Jawaban</button>
      </div>
      
      <div id="quiz" class="card"></div>
      <div id="panel" class="card"></div>
      <div id="result" class="card" style="display:none"></div>
    </div>
  </div>

<script>
// ==================== STATE ====================
let questions = [];
let current = 0;
let answers = {};
let marked = {};
let started = false;
let finished = false;
let timer = null;
let timeLeft = 0;
let currentFileName = '';

// ==================== LOAD SOAL ====================
async function loadSoalJSON() {
  // Ambil parameter ?mapel=...
  const urlParams = new URLSearchParams(window.location.search);
  const mapel = urlParams.get('mapel');
  
  // Tentukan file yang akan di-load
  let fileToLoad = 'soal.json';
  if (mapel) {
    // Format 1: dengan spasi (sesuai nama file di repo)
    fileToLoad = `${mapel}.json`;
  }
  
  // Coba load file utama
  try {
    const response = await fetch(`./${fileToLoad}`);
    if (response.ok) {
      const data = await response.json();
      processData(data, fileToLoad);
      return;
    }
  } catch (err) {
    console.log('Gagal load file utama:', err.message);
  }
  
  // Jika gagal, coba encode spasi (%20)
  if (mapel) {
    const encodedFile = `${encodeURIComponent(mapel)}.json`;
    try {
      const encodedResponse = await fetch(`./${encodedFile}`);
      if (encodedResponse.ok) {
        const data = await encodedResponse.json();
        processData(data, encodedFile);
        return;
      }
    } catch (err) {
      console.log('Gagal load encoded file:', err.message);
    }
  }
  
  // Fallback ke soal.json
  try {
    const fallback = await fetch('./soal.json');
    const data = await fallback.json();
    processData(data, 'soal.json');
  } catch (err) {
    alert('‚ùå Gagal memuat soal. Pastikan file soal.json ada.');
  }
}

function processData(data, fileName) {
  questions = Array.isArray(data) ? data : 
             (Array.isArray(data.soal) ? data.soal : []);
  currentFileName = fileName;
  console.log(`‚úÖ ${questions.length} soal dimuat dari ${fileName}`);
  render();
}

// ==================== RENDER ====================
function render() {
  const quizEl = document.getElementById('quiz');
  const panelEl = document.getElementById('panel');
  
  if (!started) {
    const mapelName = currentFileName.replace('.json', '');
    quizEl.innerHTML = `
      <div style="padding:20px;text-align:center">
        <h2>üéì SELAMAT DATANG</h2>
        <p><strong>Paket Soal:</strong> ${mapelName}</p>
        <p>Isi nama dan waktu, lalu klik <strong>"Mulai Tes"</strong>.</p>
      </div>
    `;
    panelEl.innerHTML = '';
    return;
  }
  
  if (finished) return;
  
  const q = questions[current];
  let html = `<div class="time">‚è≥ Sisa: ${Math.floor(timeLeft/60)}:${String(timeLeft%60).padStart(2,'0')}</div>`;
  html += `<div style="font-size:18px;margin-bottom:20px"><strong>Soal ${current+1}/${questions.length}:</strong> ${q.q}</div>`;
  
  if (q.type === 'multiple_choice') {
    q.choices.forEach((choice, i) => {
      const isSelected = answers[q.id] === i;
      html += `<button onclick="selectChoice(${i})" style="display:block;width:100%;margin:8px 0;padding:12px;text-align:left;background:${isSelected?'#e0f2fe':'white'};border:2px solid ${isSelected?'#38bdf8':'#cbd5e1'};border-radius:8px;color:#000000;">${String.fromCharCode(65+i)}. ${choice}</button>`;
    });
  }
  
  html += `<div style="margin-top:25px;display:flex;gap:10px">
    <button onclick="goto(${current-1})" ${current===0?'disabled':''}>‚¨ÖÔ∏è</button>
    <button onclick="toggleMark()">${marked[q.id]?'‚úì Ditandai':'üö© Tandai'}</button>
    <button onclick="goto(${current+1})" ${current===questions.length-1?'disabled':''}>‚û°Ô∏è</button>
    <button onclick="finishTest()" style="background:#dc2626">‚úÖ Kumpulkan</button>
  </div>`;
  
  quizEl.innerHTML = html;
  
  // Panel navigasi
  let panelHtml = '<div class="panel-buttons">';
  questions.forEach((q, i) => {
    let cls = [];
    if (answers[q.id] !== undefined) cls.push('answered');
    if (marked[q.id]) cls.push('marked');
    if (i === current) cls.push('current');
    panelHtml += `<button onclick="goto(${i})" class="${cls.join(' ')}">${i+1}</button>`;
  });
  panelHtml += '</div>';
  panelEl.innerHTML = panelHtml;
}

// ==================== FUNGSI NAVIGASI ====================
function selectChoice(i) { answers[questions[current].id] = i; render(); }
function toggleMark() { marked[questions[current].id] = !marked[questions[current].id]; render(); }
function goto(i) { if (i>=0 && i<questions.length) { current = i; render(); } }

// ==================== TIMER ====================
function startTest() {
  const nama = document.getElementById('namaSiswa').value.trim();
  if (!nama) { alert('Isi nama dulu!'); return; }
  
  const menit = parseInt(document.getElementById('setTime').value) || 30;
  timeLeft = menit * 60;
  started = true;
  
  clearInterval(timer);
  timer = setInterval(() => {
    timeLeft--;
    if (timeLeft <= 0) finishTest();
    render();
  }, 1000);
  
  alert(`Ujian dimulai! Nama: ${nama}, Waktu: ${menit} menit`);
  render();
}

function finishTest() {
  if (!confirm('Yakin kumpulkan?')) return;
  clearInterval(timer);
  finished = true;
  
  let total = 0, max = 0, correctCount = 0;
  questions.forEach(q => {
    const score = q.score || 1;
    max += score;
    const sc = (answers[q.id] === q.answer) ? score : 0;
    total += sc;
    if (sc > 0) correctCount++;
  });
  
  const percent = max > 0 ? Math.round((total/max)*100) : 0;
  const status = percent >= 70 ? "LULUS üéâ" : "TIDAK LULUS üí™";
  
  // Tampilkan hasil
  document.getElementById('quiz').style.display = 'none';
  document.getElementById('panel').style.display = 'none';
  
  const resultEl = document.getElementById('result');
  resultEl.style.display = 'block';
  
  // BUAT DETAIL JAWABAN
  let detailHtml = '';
  questions.forEach((q, index) => {
    const a = answers[q.id];
    const sc = (a === q.answer) ? (q.score || 1) : 0;
    const maxScore = q.score || 1;
    
    let ansText = '';
    if (q.type === 'multiple_choice') {
      ansText = a !== undefined ? `${String.fromCharCode(65+a)}. ${q.choices[a]}` : 'Belum dijawab';
    } else if (q.type === 'fill_blank') {
      ansText = a || 'Belum dijawab';
    } else if (q.type === 'essay') {
      ansText = a ? (a.length > 100 ? a.substring(0, 100) + '...' : a) : 'Belum dijawab';
    } else {
      ansText = a !== undefined ? a : 'Belum dijawab';
    }
    
    const correctAnswer = q.type === 'multiple_choice' 
      ? `${String.fromCharCode(65+q.answer)}. ${q.choices[q.answer]}`
      : q.answer;
    
    detailHtml += `
      <div style="margin-bottom:15px; padding:15px; border:1px solid #e5e7eb; border-radius:8px; background:${sc > 0 ? '#f0fdf4' : '#fef2f2'}">
        <strong>Soal ${index+1}:</strong> ${q.q}<br>
        <strong>Jawaban Anda:</strong> ${ansText}<br>
        <strong>Jawaban Benar:</strong> ${correctAnswer}<br>
        <strong>Skor:</strong> ${sc}/${maxScore}
      </div>
    `;
  });
  
  resultEl.innerHTML = `
    <h2 style="text-align:center; color:#0e639c;">üìä HASIL TES</h2>
    <div class="score-display">${total} / ${max} (${percent}%) ‚Äî ${status}</div>
    
    <div style="background:#f8fafc; padding:15px; border-radius:8px; margin:15px 0;">
      <p><strong>üë§ Nama Siswa:</strong> ${document.getElementById('namaSiswa').value}</p>
      <p><strong>üìÖ Tanggal:</strong> ${new Date().toLocaleString('id-ID')}</p>
      <p><strong>üìÇ Paket Soal:</strong> ${currentFileName}</p>
      <p><strong>‚úÖ Soal Terjawab:</strong> ${correctCount} dari ${questions.length}</p>
    </div>
    
    <h3>üìù Detail Jawaban</h3>
    <div style="max-height:400px; overflow-y:auto; margin:15px 0;">
      ${detailHtml}
    </div>
    
    <div style="text-align:center; margin-top:20px;">
      <button onclick="exportJawaban()" style="padding:12px 24px; background:#059669; margin:5px;">üì• Ekspor Jawaban</button>
      <button onclick="location.reload()" style="padding:12px 24px; background:#0e639c; margin:5px;">üîÑ Tes Baru</button>
    </div>
  `;
}

function exportJawaban() {
  const nama = document.getElementById('namaSiswa').value.trim() || 'Anonim';
  const data = { 
    nama, 
    tanggal: new Date().toISOString(),
    waktuUjian: document.getElementById('setTime').value,
    paketSoal: currentFileName,
    totalSkor: questions.reduce((sum, q) => sum + (answers[q.id] === q.answer ? (q.score || 1) : 0), 0),
    totalMaksimal: questions.reduce((sum, q) => sum + (q.score || 1), 0),
    jawaban: answers,
    soal: questions 
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  
  // NAMA FILE: Jawaban_namasiswa_namapaket.json
  const namaFile = `Jawaban_${nama.replace(/\s+/g,'_')}_${currentFileName.replace('.json','')}.json`;
  a.download = namaFile;
  
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  alert(`‚úÖ Jawaban berhasil diekspor!\nFile: ${namaFile}`);
}

// ==================== INIT ====================
document.addEventListener('DOMContentLoaded', loadSoalJSON);
</script>
</body>
</html>
